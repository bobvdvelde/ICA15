{
    "contents" : "### Topic model validation script ###\nlibrary(\"MASS\")\nlibrary(\"car\")\nlibrary(\"parallel\")\n\n# If on windows, run code below  (http://www.stat.cmu.edu/~nmv/2014/07/14/implementing-mclapply-on-windows/)\n# source(\"http://www.stat.cmu.edu/~nmv/setup/mclapply.hack.R\")\n\n\n\n# The estimation model for topics as label predictors\nvalmodel<-\n  function(x){\n  print(x)\n  fit <- tryCatch({glm.nb( paste(x, \"~\", paste(\"X\",1:149, sep=\"\", collapse=\"+\"),collapse=\"\"), data=dfr )},error=function(e){return(glm.nb(paste(x,\"~ 1\"),dfr))})\n  nonnacoefs <- names(summary(fit)$coefficients[,1])[ !is.na(summary(fit)$coefficients[,1])]\n  fit <- tryCatch({ update(fit, formula=paste(\".~\",paste(nonnacoefs[nonnacoefs!=\"(Intercept)\"],sep=\"\",collapse=\"+\"))) },error=function(e){return(glm.nb(paste(x,\"~ 1\"),dfr))})\n  sigcoefs <- names(summary(fit)$coefficients[,1])[summary(fit)$coefficients[,4]<0.05 & !is.na(summary(fit)$coefficients[,1])]\n  if(length(sigcoefs)>1)\n  {fit <- update(fit, formula=paste(\".~\",paste(sigcoefs[sigcoefs!=\"(Intercept)\"],sep=\"\",collapse=\"+\")))} else {fit <- update(fit,formula=\".~1\")}\n  nonnegcoefs <- names(summary(fit)$coefficients[,1])[summary(fit)$coefficients[,1]>0 & summary(fit)$coefficients[,4]<0.05 & !is.na(summary(fit)$coefficients[,1])]\n  if(length(sigcoefs)>1 & length(nonnegcoefs)>1)\n  {fit <- update(fit, formula=paste(\".~\",paste(nonnegcoefs[nonnegcoefs!=\"(Intercept)\"],sep=\"\",collapse=\"+\")))}else{fit <-update(fit,formula=\".~1\")}\n  #models[[y]][[f]][[n]] <- fit\n  c(x,BIC(fit),length(coef(fit))-1,paste(names(coef(fit)), collapse=\",\" ))\n}\n\n### May take a long time (like 3 hours...) ###\nprint(\"loading orgdata\")\norgdata <- read.csv2('orgdata.csv', header=T, sep = \",\")\norgdata <- orgdata[,c('id','FisYr','NTEE.COMMON.CODE')]\n\nfor(nt in levels(orgdata$NTEE.COMMON.CODE)){\n  orgdata[[nt]] <- orgdata$NTEE.COMMON.CODE == nt\n}\n\nresults <- list()\nmodels <- list()\nmodelmatrices <- list()\nfor(y in 2007:2011){\n  results[[y]] <- list()\n  models[[y]]<- list()\n  modelmatrices[[y]] <- list()\n  print(y)\n  for(f in list.files()){\n    if(grepl(\"idtopic.csv\",f)){\n      print(\"making data\")\n      models[[y]][[f]]<-list()\n      print(f)\n      # Prepare file\n      tf <- read.csv(f,header=T)\n      dfr <- merge(orgdata,tf)\n      dfr <- dfr[dfr$year==y & !is.na(dfr$year) & !is.na(dfr[1]),]\n      for(n in c(\"id\",\"FisYr\",\"NTEE.COMMON.CODE\",\"V4\",\"id\",\"name\",\"year\")){dfr[[n]]<-NULL}\n      # Run correlation\n      #results[[y]][[f]] <- cor(dfr[1:26], dfr[27:dim(dfr)[2]], use=\"pairwise.complete.obs\")\n      # Shorten NTEE Codes to letter (removes label)\n      names(dfr)[1:26] <- sapply(names(dfr)[1:26],function(x){strsplit(x,\":\")[[1]][1]})\n      \n      # Run glm models\n      print(\"running models\")\n      fitted <- data.frame(dep=character(), bic=numeric())\n      # Run 0 models for each label\n      if(length(modelmatrices[[y]])<2){\n        print(\"running baseline\")\n        temp <- c()\n        for(i in 1:26) {temp <- c(temp,BIC(glm.nb(paste(names(dfr)[i], \"~1\"),dfr)))}\n        tdf <- data.frame(null=temp); \n        tdf <- rbind(tdf,0); \n        rownames(tdf)<-c(names(dfr[1:26]),\"U ratio\")\n        modelmatrices[[y]]<-tdf\n      }\n      # Run linear model for each NTEE code\n      allpred <- c()\n      print(\"going multicore\")\n      fits <-t(data.frame(mclapply(names(dfr[1:26]),valmodel)))\n      rownames(fits)<-fits[,1]; \n      usedcoef<-factor(strsplit(paste(rbind(fits[,4]),collapse=\",\"),\",\")[[1]])\n      u_ratio <- length(unique(usedcoef))/length(usedcoef)\n      fits <- fits[,2:3]\n      tiframe <- data.frame(as.numeric(fits[,1]),as.integer(fits[,2])); tiframe <- rbind(tiframe,c(u_ratio,length(unique(usedcoef))))\n      colnames(tiframe)<-c(f,\"terms\")\n      modelmatrices[[y]] <- cbind(modelmatrices[[y]],tiframe)\n    }\n  }\n}\n",
    "created" : 1431945239168.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3768961547",
    "id" : "57F2933F",
    "lastKnownWriteTime" : 1424695406,
    "path" : "C:/Users/Bob/Dropbox/INFUSE/Phase 5- BD/Descriptive Analysis/topic_validation/mcvalidate_topics.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}